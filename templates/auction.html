<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IPL Auction - {% if current_player_for_auction %}{{ current_player_for_auction.name }}{% else %}No Player Selected{% endif %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .auction-layout { display: flex; justify-content: space-between; margin-top: 20px; }
        .player-display { width: 40%; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9; box-shadow: 2px 2px 5px #eee;}
        .bidding-panel { width: 58%; }
        .bid-log { height: 150px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background-color: #fff; }
        .bid-log p { margin: 2px 0; font-size: 0.9em; }
        .bid-log .system { color: #007bff; font-style: italic; }
        .bid-log .user-bid { color: #28a745; font-weight: bold;}
        .bid-log .ai-bid { color: #dc3545; } /* This might need actual team name class if we want specific AI team colors */
        .team-budgets { margin-top:15px; }
        .team-budgets table { width:100%; border-collapse: collapse; }
        .team-budgets th, .team-budgets td { border:1px solid #ddd; padding: 4px; text-align: left; font-size:0.85em; }
        .user-dashboard { background-color: #e9f5ff; padding: 10px; border-radius: 5px; margin-top: 15px;}
        .user-dashboard h3 { margin-top:0; }
        .user-dashboard ul { list-style: none; padding-left: 0;}
        .user-dashboard ul li { margin-bottom: 3px; font-size:0.9em;}
        .player-status-message { padding: 10px; background-color: #ffc107; color: #333; border-radius: 4px; margin-bottom: 15px; text-align: center; font-weight: bold;}
        .auction-over-message { padding: 10px; background-color: #17a2b8; color: white; text-align: center; font-weight: bold; margin-bottom: 15px;}
    </style>
</head>
<body>
    <header>
        <h1>IPL Auction{% if not auction_over %} - Player {{current_player_auction_number}} of {{total_players_in_auction_pool}}{% else %} Over{% endif %}</h1>
    </header>

    <div class="container">
        {% if auction_over %}
            <div class="auction-over-message">
                The auction is now complete.
                <p><a href="{{ url_for('auction_summary_page') }}" class="button-like">View Final Auction Summary</a></p>
            </div>
        {% endif %}

        {% if current_player_for_auction and not auction_over %}
            <div class="auction-layout">
                <div class="player-display">
                    <h2>Up for Auction: {{ current_player_for_auction.name }}</h2>
                    <p><strong>Role:</strong> {{ current_player_for_auction.role }}</p>
                    <p><strong>Base Price:</strong> ₹{{ current_player_for_auction.base_price }}L</p>
                    <p><strong>Demand Score:</strong> {{ current_player_for_auction.demand }}</p>
                    <hr>
                    <h4>Stats:</h4>
                    <p>Runs: {{ current_player_for_auction.runs }} | Avg: {{ current_player_for_auction.avg }} | SR: {{ current_player_for_auction.sr }}</p>
                    <p>Wickets: {{ current_player_for_auction.wickets }} | Eco: {{ current_player_for_auction.eco }}</p>
                </div>

                <div class="bidding-panel">
                    <h3>Current Highest Bid: ₹{{ current_highest_bid }}L</h3>
                    <p><strong>Highest Bidder:</strong> <span id="highestBidderName">{{ current_highest_bidder_display_name }}</span></p>

                    <h4>Bid Log:</h4>
                    <div class="bid-log">
                        {% for bid_entry in bids_log %}
                            {# Determine class based on bidder - assumes user team name is available or a generic 'user-bid' #}
                            {% set bidder_class = 'system' %}
                            {% if bid_entry.bidder == user_team_display_name %}
                                {% set bidder_class = 'user-bid' %}
                            {% elif bid_entry.bidder != 'System' %}
                                {% set bidder_class = 'ai-bid' %} {# Or more specific if AI team names are used in log #}
                            {% endif %}
                            <p class="{{ bidder_class }}">
                               [{{ bid_entry.timestamp }}] <strong>{{ bid_entry.bidder }}:</strong> {{ bid_entry.info }}
                            </p>
                        {% else %}
                            <p>No bids placed yet for this player.</p>
                        {% endfor %}
                    </div>

                    <form action="{{ url_for('auction_bid') }}" method="POST" style="display:inline;">
                        <input type="number" name="bid_amount" placeholder="Your Bid (Lakhs)" min="{{ current_highest_bid + 10 if current_player_for_auction.base_price == current_highest_bid else current_highest_bid + 10 }}" step="10" required>
                        <button type="submit">Place Bid</button>
                    </form>

                    <form action="{{ url_for('auction_finalize_player') }}" method="POST" style="display:inline;">
                        <button type="submit" onclick="return confirm('Are you sure you want to pass on this player? The player will be sold to the current highest bidder or remain unsold.')">Pass & Finalize Player</button>
                    </form>
                </div>
            </div>
        {% elif not auction_over %}
            <p>Loading next player for auction...</p>
             <script>
                setTimeout(function(){ window.location.reload(); }, 3000); // Auto-refresh if stuck
            </script>
        {% endif %}

        <div class="user-dashboard">
            <h3>Your Team: {{ user_team_display_name }}</h3>
            <p>Budget Remaining: ₹{{ user_team_current_budget }}L</p>
            <p>Squad: {{ user_squad_display | length }} / {{ user_team_max_squad }} players</p>
            <ul>
                {% for p_info in user_squad_display %}
                <li>{{p_info.name}} ({{p_info.role}}) - {{p_info.display_price}}</li>
                {% else %}
                <li>No players in squad yet.</li>
                {% endfor %}
            </ul>
        </div>

        <div class="team-budgets">
            <h4>All Team Budgets:</h4>
            <table>
                <tr><th>Team</th><th>Budget (Lakhs)</th><th>Squad Size</th></tr>
                {% for team_info in all_teams_budgets_info %}
                <tr>
                    <td>{{ team_info.name }}</td>
                    <td>₹{{ team_info.budget }}L</td>
                    <td>{{ team_info.squad_count }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        <hr style="margin-top: 20px;">
        <p>
            <a href="{{ url_for('index') }}">Quit Auction (Reset Session)</a>
            {% if not auction_over %}
            | <a href="{{ url_for('auction_summary_page') }}" onclick="return confirm('This will end the current auction and take you to the summary. Are you sure?')">End Auction & Go to Summary</a>
            {% endif %}
        </p>

    </div>
</body>
</html>
